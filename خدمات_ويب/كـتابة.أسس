اشمل "دمـغة.أسس"؛
اشمل "مـتم/نـص.أسس"؛
اشمل "مـتم/مـصفوفة.أسس"؛

صنف كـتابة {
    عرف مـحاذاة: {
        عرف _يمين_: 1؛
        عرف _يسار_: 2؛
        عرف _وسط_: 0؛
    }

    عرف _خط_الكتابة_: "30px AlususMono"؛
    عرف لون: لـون؛
    عرف عربي: صحيح = 0؛
    عرف محاذاة: صحيح = مـحاذاة._يسار_؛
    عرف تباعد_الأسطر: صحيح = 0؛
    عرف مرسم: مـورد_مرسم؛
    عرف المرسم_مجهز: ثـنائي = 0؛

    عرف نص: نـص؛
    عرف سطور: مـصفوفة[دمـغة]؛
    عرف س: صحيح؛
    عرف ص: صحيح؛
    عرف رقم: صحيح = 0؛

    عملية هذا.تهيئة (ل: لـون، س: صحيح، ص: صحيح) {
        هذا.حرر_السطور()؛
        هذا.نص = ""؛
        هذا.لون = ل؛
        هذا.س = س؛
        هذا.ص = ص؛
    }

    عملية هذا.عين_النص (ن: مـؤشر_محارف) {
        إذا هذا.نص == ن ارجع؛
        هذا.نص = ن؛
        هذا.هيئ_السطور()؛
    }

    عملية هذا.عين_النص(ر: صحيح) {
        إذا ر == هذا.رقم و هذا.نص != "" ارجع؛
        هذا.نص = نـص() + ر؛
        هذا.رقم = ر؛
        هذا.هيئ_السطور()؛
    }

    عملية هذا.هيئ_السطور() {
        هذا.حرر_السطور()؛
        عرف نصوص: مـصفوفة[نـص] = هذا.نص.قطع("\ج")؛
        عرف م: صحيح؛
        لكل م = 0، م < نصوص.هات_الطول()، ++م {
            عرف ن: سـندنا[مـورد_صورة] = هذا.أنشئ_نقش_كتابة(نصوص(م)، هذا.لون، هذا.عربي)؛
            هذا.سطور.أضف(دمـغة(ن))؛
        }
    }

    عملية هذا.أنشئ_نقش_كتابة (نص: نـص، لون: لـون، عربي: صحيح): سـندنا[مـورد_صورة] {
        هذا.جهز_المرسم()؛
        هذا.مرسم.فرغ()؛
        هذا.مرسم.حدد_الاتجاه(مؤشر[محرف]().{ إذا عربي != 0 هذا = "rtl" وإلا هذا = "ltr" })؛
        هذا.مرسم.حدد_نمط_الملء(لون~مثل[نـص]، لون~مثل[نـص]، 0، 0، 1، 1)؛
        هذا.مرسم.ارسم_كتابة(نص, _خط_الكتابة_, 0، 0)؛
        عرف صورة: سـندنا[مـورد_صورة]؛
        صورة.أنشئ()؛
        صورة.هيئ_من_مرسم(هذا.مرسم)؛
        أرجع صورة؛
    }

    عملية هذا.جهز_المرسم() {
        إذا هذا.المرسم_مجهز ارجع؛
        عرف أبعاد: أبـعاد = المرسم.قس_أبعاد_كتابة("0"، _خط_الكتابة_)؛
        هذا.مرسم.هيئ(أبعاد.عرض * 6، أبعاد.طول)؛
        هذا.المرسم_مجهز = 1؛
    }

    عملية هذا.حرر_السطور() {
        هذا.سطور.فرغ()؛
    }

    عملية هذا.هات_الأبعاد (): أبـعاد {
        عرف أبعاد: أبـعاد؛
        أبعاد.عرض = أبعاد.طول = 0؛
        عرف م: صحيح؛
        لكل م = 0، م < هذا.سطور.هات_الطول()، ++م {
            أبعاد.طول += هذا.سطور(م).طول؛
            إذا م != 0 أبعاد.طول += هذا.تباعد_الأسطر؛
            إذا أبعاد.عرض < هذا.سطور(م).عرض { أبعاد.عرض = هذا.سطور(م).عرض }
        }
        أرجع أبعاد؛
    }

    عملية هذا.اطمغ() {
        هذا.اطمغ(هذا.س، هذا.ص)؛
    }

    عملية هذا.اطمغ(س: صحيح، ص: صحيح) {
        عرف م: صحيح؛
        لكل م = 0، م < هذا.سطور.هات_الطول()، ++م {
            إذا هذا.محاذاة == مـحاذاة._يمين_ {
                هذا.سطور(م).اطمغ(س - هذا.سطور(م).عرض، ص)؛
            } وإلا إذا هذا.محاذاة == مـحاذاة._يسار_ {
                هذا.سطور(م).اطمغ(س، ص)؛
            } وإلا {
                هذا.سطور(م).اطمغ(س - هذا.سطور(م).عرض ÷ 2، ص)؛
            }
            ص += هذا.سطور(م).طول + هذا.تباعد_الأسطر؛
        }
    }
}

